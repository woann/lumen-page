<style type="text/css">
  .uploader-list {
    margin-left: -15px;
  }

  .uploader-list .info {
    position: relative;
    margin-top: -25px;
    background-color: black;
    color: white;
    filter: alpha(Opacity=80);
    -moz-opacity: 0.5;
    opacity: 0.5;
    width: 100px;
    height: 25px;
    text-align: center;
    display: none;
  }

  .uploader-list .handle {
    position: relative;
    background-color: black;
    color: white;
    filter: alpha(Opacity=80);
    -moz-opacity: 0.5;
    opacity: 0.5;
    width: 100px;
    text-align: right;
    height: 18px;
    margin-bottom: -18px;
    display: none;
  }

  .uploader-list .handle span {
    margin-right: 5px;
  }

  .uploader-list .handle span:hover {
    cursor: pointer;
  }

  .uploader-list .file-iteme {
    margin: 12px 0 0 15px;
    padding: 1px;
    float: left;
  }
  .layui-icon-delete{
    cursor: pointer;
  }
</style>
<div class="layui-fluid">
  <div class="layui-card">
    <div class="layui-card-header">请完善商品信息</div>
    <div class="layui-card-body" style="padding: 15px;">
      <div id="goods_update_view"></div>
    </div>
  </div>
</div>
<script type="text/html" id="goods_update_form">
  <form class="layui-form" action="" lay-filter="LAY-goods-update">
    <div class="layui-tab layui-tab-brief">
      <ul class="layui-tab-title">
        <li id="show_basic" class="layui-this">基本信息</li>
        <li id="show_pic">图片上传</li>
        <li id="show_other">详细信息</li>
        <li id="show_sy">溯源信息</li>
      </ul>
      <div class="layui-tab-content" >
        <div class="layui-tab-item  layui-show" >
          <div class="layui-form-item">
            <label class="layui-form-label"><span style="color: red;">*</span> 商品名称</label>
            <div class="layui-input-block">
              <input type="text" name="goods_name"  lay-verify="required" autocomplete="off" placeholder="商品名称" value="{{ d.goods_name }}" class="layui-input">
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label"><span style="color: red;">*</span> 商品分类</label>
            <div class="layui-input-block">
              <div class="layui-inline">
                <select name="cat_id" lay-verify="required">
                </select>
              </div>
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label"><span style="color: red;">*</span> 背景颜色</label>
            <div class="layui-input-inline" style="width: 120px;">
              <input type="text" lay-verify="required" value="{{ d.goods_name_style }}" name="goods_name_style" placeholder="请选择背景颜色" class="layui-input" id="goods_name_style">
            </div>
            <div class="layui-inline"  style="left: -11px;">
              <div id="color-form"></div>
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label"><span style="color: red;">*</span> 售价</label>
            <div class="layui-input-block">
              <input type="number" name="shop_price" value="{{ d.shop_price }}" lay-verify="required" autocomplete="off" placeholder="实际销售价格" class="layui-input">
            </div>
          </div>


          <div class="layui-form-item">
            <label class="layui-form-label"><span style="color: red;">*</span> 成本价</label>
            <div class="layui-input-block">
              <input type="number" name="cost_price" value="{{ d.cost_price }}"  lay-verify="required" autocomplete="off" placeholder="成本价" class="layui-input">
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label"><span style="color: red;">*</span> 原价</label>
            <div class="layui-input-block">
              <input type="number" name="market_price" value="{{ d.market_price }}"  lay-verify="required" autocomplete="off" placeholder="原价(虚拟价格,展示用)" class="layui-input">
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label"><span style="color: red;">*</span> 库存</label>
            <div class="layui-input-block">
              <input type="number" name="goods_number" value="{{ d.goods_number }}"  lay-verify="required" autocomplete="off" placeholder="库存" class="layui-input">
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">单位</label>
            <div class="layui-input-block">
              <input type="text" name="goods_unit" value="{{ d.goods_unit }}"  autocomplete="off" placeholder="单位" class="layui-input">
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">重量(kg)</label>
            <div class="layui-input-block">
              <input type="number" name="goods_weight" value="{{ d.goods_weight }}"   autocomplete="off" placeholder="重量(kg)" class="layui-input">
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">运费(元)</label>
            <div class="layui-input-block">
              <input type="number" name="shipping_fee" value="{{ d.shipping_fee }}"  autocomplete="off" placeholder="运费(元)" class="layui-input">
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">排序</label>
            <div class="layui-input-block">
              <input type="number" name="sort_order" value="{{ d.sort_order }}" autocomplete="off" placeholder="数值越大越靠前" class="layui-input" value="0">
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">虚拟销量</label>
            <div class="layui-input-block">
              <input type="number" name="virtual_num"  value="{{ d.virtual_num }}"  autocomplete="off" placeholder="虚拟销量" class="layui-input">
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">赠送积分</label>
            <div class="layui-input-block">
              <input type="number" name="give_integral"  value="{{ d.give_integral }}"  autocomplete="off" placeholder="赠送积分" class="layui-input">
            </div>
          </div>
          <div class="layui-form-item">
            <div class="layui-input-block">
              <div class="layui-footer">
                <button class="layui-btn" lay-submit="" lay-filter="show_pic">下一步</button>
              </div>
            </div>
          </div>
        </div>
        <div class="layui-tab-item" >
          <div class="layui-form-item">
            <label class="layui-form-label"><span style="color: red;">*</span> 缩略图</label>
            <div class="layui-input-inline">
              <div class="layui-upload">
                <button type="button" class="layui-btn" id="upload_thumb">上传缩略图</button>
                <input type="hidden" name="goods_thumb" value="{{ d.goods_thumb }}">
                <div class="layui-upload-list">
                  <img width="100" class="layui-upload-img" id="show" src="{{ layui.setter.resources_url+d.goods_thumb }}">
                  <p id="demoText"></p>
                </div>
              </div>
            </div>
            <div class="layui-form-mid layui-word-aux">推荐尺寸:702px * 388px</div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label"><span style="color: red;">*</span> 轮播图</label>
            <div class="layui-input-inline">
              <div class="layui-upload">
                <button type="button" class="layui-btn" id="test2">上传轮播图</button>
              </div>
            </div>
            <div class="layui-form-mid layui-word-aux">推荐尺寸:750px * 520px</div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">　</label>
            <div class="layui-input-block">
              <div class="layui-upload">
                <blockquote id="yl_image" class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;width: 88%">
                      预览图：
                      <div class="layui-upload-list uploader-list" style="overflow: auto;" id="uploader-list">
                  {{#  layui.each(d.goods_pics, function(index, item){ }}
                  <div  class="file-iteme">
                    <div class="handle"><i class="layui-icon layui-icon-delete"></i></div>
                    <img style="width: 100px;height: 100px;" src="{{ layui.setter.resources_url+ item }}">
                    <div class="info">{{ item }}</div>
                    <input type="hidden" name="goods_pics[]" value="{{ item }}">
                  </div>
                  {{#  }); }}
                      </div>
                </blockquote>
              </div>
            </div>
          </div>

          <div class="layui-form-item">
            <div class="layui-input-block">
              <div class="layui-footer">
                <button class="layui-btn layui-btn-warm" lay-submit="" lay-filter="show_basic">上一步</button>
                <button class="layui-btn" lay-submit="" lay-filter="show_other">下一步</button>
              </div>
            </div>
          </div>
        </div>
        <div class="layui-tab-item" >
          <div class="layui-form-item">
            <label class="layui-form-label">服务内容</label>
            <div class="layui-input-block">
              <textarea name="service" placeholder="正品保障/冷链运输" class="layui-textarea">{{ d.service ? d.service : '' }}</textarea>
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">商品描述</label>
            <div class="layui-input-block">
              <textarea name="goods_summary" placeholder="商品描述"  class="layui-textarea">{{ d.goods_summary }}</textarea>
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label"><span style="color: red;">*</span> 商品详情</label>
            <div class="layui-input-block">
              <div id="editor">{{ d.goods_desc }}</div>
            </div>
          </div>
          <div class="layui-form-item">
            <div class="layui-input-block">
              <div class="layui-footer">
                <button class="layui-btn layui-btn-warm" lay-submit="" lay-filter="show_pic">上一步</button>
                <button class="layui-btn" lay-submit="" lay-filter="show_sy">下一步</button>
              </div>
            </div>
          </div>
        </div>

        <div class="layui-tab-item" >
          <div class="layui-form-item">
            <label class="layui-form-label"><span style="color: red;">*</span> 溯源详情</label>
            <div class="layui-input-block">
              <div id="sy_editor">{{ d.goods_traceability }}</div>
            </div>
          </div>
          <div class="layui-form-item">
            <div class="layui-input-block">
              <div class="layui-footer">
                <button class="layui-btn layui-btn-warm" lay-submit="" lay-filter="show_pic">上一步</button>
                <button class="layui-btn" lay-submit="" lay-filter="LAY-goods-update">立即提交</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</script>
<script type="text/html" template lay-done="layui.data.sendParams(d.params)"></script>
<script>
  layui.data.sendParams = function(params) {
    var goods_id = params.id; //得到传递过来的 id 参数（或其他参数）值
    layui.use(['admin', 'form', 'laydate', 'upload', 'colorpicker'], function () {
      var $ = layui.$
              , admin = layui.admin
              , laytpl = layui.laytpl
              , layer = layui.layer
              , laydate = layui.laydate
              , form = layui.form
              , upload = layui.upload
              , table = layui.table
              ,colorpicker = layui.colorpicker;

      form.render(null, 'LAY-goods-update');

      laydate.render({
        elem: '#LAY-LAY-goods-update-date'
      });

      //建立编辑器
      var E = window.wangEditor;
      var editor = new E('#editor');
      editor.customConfig.uploadImgServer = layui.setter.server_url + '/editor_upload?path=pinpin-goods/editor&access_token='+ encodeURIComponent(layui.data('layuiAdmin').access_token);
      editor.customConfig.uploadFileName = 'file[]';

      var sy_editor = new E('#sy_editor');
      sy_editor.customConfig.uploadImgServer = layui.setter.server_url + '/editor_upload?path=pinpin-goods/editor&access_token='+ encodeURIComponent(layui.data('layuiAdmin').access_token);
      sy_editor.customConfig.uploadFileName = 'file[]';

      //获取原始数据
      admin.req({
        url: layui.setter.server_url + "/goods/update",
        type: "get",
        data:{id:goods_id},
        async:false,
        done: function (res) {
          var getTpl = goods_update_form.innerHTML,view = document.getElementById('goods_update_view');
          laytpl(getTpl).render(res.data, function(html){
            view.innerHTML = html;
          });
          colorpicker.render({
            elem: '#color-form'
            ,color: res.data.goods_name_style
            ,done: function(color){
              $('input[name="goods_name_style"]').val(color);
            }
          });
          form.render();
          editor.create();
          sy_editor.create();
        }
      });

      //上传商品轮播图
      upload.render({
        elem: '#test2'
        , url: layui.setter.server_url + '/upload'
        , data: {path: 'pinpin-goods/goods', access_token: layui.data('layuiAdmin').access_token}
        , multiple: true
        , before: function (obj) {
          //预读本地文件示例，不支持ie8
          obj.preview(function (index, file, result) {
            // $('#demo2').append('<img src="' + result + '" alt="' + file.name + '" class="layui-upload-img">')

          });
        }
        , done: function (res) {
          if (res.code == 0) {
            $('#yl_image').show();
            $('#uploader-list').append(
                    '<div id="" class="file-iteme">' +
                    '<div class="handle"><i class="layui-icon layui-icon-delete"></i></div>' +
                    '<img style="width: 100px;height: 100px;" src="'+ res.data.src +'">' +
                    '<div class="info">' + res.data.filename + '</div>' +
                    '<input type="hidden" name="goods_pics[]" value="'+res.data.filename+'">'+
                    '</div>'
            );
          } else {
            layer.msg(res.msg, {
              offset: '15px'
              , icon: 5
              , time: 1000
            }, function () {
            });
            return false;
          }
        }
      });
      //获取商品分类
      admin.req({
        url: layui.setter.server_url + "/category/list",
        type: "get",
        done: function (res) {
          var data = res.data;
          var html = '';
          for (i = 0; i < data.length; i++) {
            html += '<option value="' + data[i].cat_id + '">' + data[i].cat_name + '</option>';
          }
          $('select[name="cat_id"]').append(html);
          form.render('select');
        }
      });
      //上传缩略图
      var uploadInst = upload.render({
        elem: '#upload_thumb'
        , url: layui.setter.server_url + '/upload'
        , data: {path: 'pinpin-goods/goods', access_token: layui.data('layuiAdmin').access_token}
        , before: function (obj) {
          obj.preview(function (index, file, result) {
            $('#show').attr('src', result); //图片链接（base64）
          });
        }
        , done: function (res) {
          //如果上传失败
          if (res.code != 0) {
            layer.msg(res.msg, {
              offset: '15px'
              , icon: 5
              , time: 1000
            }, function () {
            });
            return false;
          }
          //上传成功
          $('input[name="goods_thumb"]').val(res.data.filename);
          layer.msg('上传成功', {
            offset: '15px'
            , icon: 1
            , time: 1000
          }, function () {
          });

        }
        , error: function () {
          //演示失败状态，并实现重传
          var demoText = $('#demoText');
          demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
          demoText.find('.demo-reload').on('click', function () {
            uploadInst.upload();
          });
        }
      });
      //鼠标移入
      $(document).on("mouseenter mouseleave", ".file-iteme", function(event){
        if(event.type === "mouseenter"){
          //鼠标悬浮
          $(this).children(".info").fadeIn("fast");
          $(this).children(".handle").fadeIn("fast");
        }else if(event.type === "mouseleave") {
          //鼠标离开
          $(this).children(".info").hide();
          $(this).children(".handle").hide();
        }
      });
      // 删除图片
      $(document).on("click", ".file-iteme .handle", function(event){
        $(this).parent().remove();
        if( $('.file-iteme').length == 0){
          $('#yl_image').hide();
        }
      });
      //提交
      form.on('submit(LAY-goods-update)', function (data) {
        data.field.goods_desc = editor.txt.html();
        data.field.goods_traceability = sy_editor.txt.html();
        data.field.id = goods_id;
        admin.req({
          url: layui.setter.server_url + "/goods/update",
          type: "post",
          data: data.field,
          done: function (res) {
            layer.closeAll();
            layer.msg(res.msg, {
              offset: '15px'
              ,icon: 1
              ,time: 1000
            }, function(){
              table.reload('goods_list', {
              });
            });
          }
        });
        return false;
      });
      form.on('submit(show_basic)', function(data){
        $('#show_basic').click();
        return false;
      });
      form.on('submit(show_pic)', function(data){
        $('#show_pic').click();
        return false;
      });
      form.on('submit(show_other)', function(data){
        $('#show_other').click();
        return false;
      });
    });
  }
</script>